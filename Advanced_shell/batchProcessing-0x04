#!/bin/bash

# Task 5: Parallel Data Fetching
# Fetch multiple Pokemon data in parallel using background processes

API_BASE="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
MAX_RETRIES=3
DELAY=2

# List of Pokemon to fetch
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Create output directory if it doesn't exist
mkdir -p "${OUTPUT_DIR}"

# Array to store background process IDs
declare -a PIDS

# Function to fetch Pokemon data with retry logic
fetch_pokemon() {
    local pokemon=$1
    local output_file="${OUTPUT_DIR}/${pokemon}.json"
    local attempt=1
    
    echo "Fetching data for ${pokemon}..."
    
    while [ ${attempt} -le ${MAX_RETRIES} ]; do
        # Make API request
        http_code=$(curl -s -o "${output_file}" -w "%{http_code}" "${API_BASE}/${pokemon}")
        
        if [ "${http_code}" -eq 200 ]; then
            echo "Saved data to ${output_file} "
            return 0
        else
            echo "Attempt ${attempt}/${MAX_RETRIES} failed for ${pokemon} (HTTP ${http_code})"
            attempt=$((attempt + 1))
            
            if [ ${attempt} -le ${MAX_RETRIES} ]; then
                sleep ${DELAY}
            fi
        fi
    done
    
    # All retries failed
    echo "Error: Failed to fetch ${pokemon} after ${MAX_RETRIES} attempts" | tee -a errors.txt
    return 1
}

# Cleanup function to kill background jobs on exit
cleanup() {
    echo "Cleaning up background processes..."
    jobs -p | xargs -r kill 2>/dev/null
    wait
}

# Set trap for cleanup on script exit
trap cleanup EXIT INT TERM

# Launch all fetches in parallel
echo "Starting parallel fetch for ${#POKEMON_LIST[@]} Pokemon..."
for pokemon in "${POKEMON_LIST[@]}"; do
    fetch_pokemon "${pokemon}" &
    PIDS+=($!)
done

# Show running background jobs
echo "Active background jobs:"
jobs

# Wait for all background processes to complete
echo "Waiting for all parallel processes to complete..."
for pid in "${PIDS[@]}"; do
    wait ${pid}
done

echo "Parallel batch processing complete!"