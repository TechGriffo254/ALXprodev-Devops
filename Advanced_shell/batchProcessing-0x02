#!/bin/bash

# Task 2 & 4: Batch Pokemon Data Retrieval with Error Handling and Retry Logic
# Fetch multiple Pokemon data with retry mechanism

API_BASE="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
MAX_RETRIES=3
DELAY=2

# List of Pokemon to fetch
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Create output directory if it doesn't exist
mkdir -p "${OUTPUT_DIR}"

# Function to fetch Pokemon data with retry logic
fetch_pokemon() {
    local pokemon=$1
    local output_file="${OUTPUT_DIR}/${pokemon}.json"
    local attempt=1
    
    echo "Fetching data for ${pokemon}..."
    
    while [ ${attempt} -le ${MAX_RETRIES} ]; do
        # Make API request
        http_code=$(curl -s -o "${output_file}" -w "%{http_code}" "${API_BASE}/${pokemon}")
        
        if [ "${http_code}" -eq 200 ]; then
            echo "Saved data to ${output_file} âœ…"
            return 0
        else
            echo "Attempt ${attempt}/${MAX_RETRIES} failed for ${pokemon} (HTTP ${http_code})"
            attempt=$((attempt + 1))
            
            if [ ${attempt} -le ${MAX_RETRIES} ]; then
                sleep ${DELAY}
            fi
        fi
    done
    
    # All retries failed
    echo "Error: Failed to fetch ${pokemon} after ${MAX_RETRIES} attempts" | tee -a errors.txt
    return 1
}

# Fetch each Pokemon sequentially
for pokemon in "${POKEMON_LIST[@]}"; do
    fetch_pokemon "${pokemon}"
    sleep 1  # Rate limiting delay
done

echo "Batch processing complete!"
